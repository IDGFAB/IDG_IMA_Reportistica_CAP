sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/export/Spreadsheet","sap/ui/thirdparty/jquery","sap/m/ObjectAttribute","sap/ui/model/Sorter"],function(e,t,i,jQuery,o,n){"use strict";return e.extend("imareport9.controller.Homepage",{onInit:function(){this.getView().setModel(new t,"selectedFiltersModel");this._initializeFilters();this.osUrl=this.getOwnerComponent().getModel().sServiceUrl;this._createFiltersModel();this._getDataFilters();this.getView().setModel(new t,"DataIMA9");let e=this.getView().getModel("selectedFiltersModel");e.setProperty("/matchData",false);this.entityKeys;this.typeContractKeys;this.contractKeys;this.cdcKeys;this.annoKey;this.periodoKey},onAfterRendering:function(){this.makeTitleObjAttrBold();this.disableFilterStart();const e=[{ASSET_CLASS:"Guest quarters in benefit",INTERCOMPANY:"NO",CDC:"000175AT00",CDC_CODE:null,LEASE_N:"",CONTRACT_CODE:"0000000400001",ACC_SECTOR:"ATOP",CONTRACT_DESCRIPTION:"x",MERGED_ENTITY:"",RIGHT_OF_USE:"0e+0",ACCUMULATED_DEPRECIATION:"3.286478e+4",NET_RIGHT_OF_USE:"0e+0",CLOSING_LEASES_LIABILITIES:"0e+0",LEASE_LIABILITIES_SHORT_TERM:"0e+0",LEASE_LIABILITIES_LONG_TERM:"0e+0",YTD_INTEREST:"3.331e+1",LEASE_COST:"3.6e+3",DEPRECIATION:"3.24323e+3",GAIN_FX_RATES:0,LOSS_FX_RATES:0}]},getTableMockData:function(){return[{Data:{Entity:"ILAPAK INTERNATIONAL SA",Scenario:"Actua",Period:"December",Year:2023,Currency:"EUR",Opening:{"Right of Use":{Total:99999999,Building:17910324,Cars_in_pool:278436,Cars_in_benefit:450944},"Accumulated Depreciation":{Total:6560981,Building:6097132,Cars_in_pool:223233,Cars_in_benefit:240616},"Net Right of Use":{Total:12078722,Building:11813193,Cars_in_pool:55203,Cars_in_benefit:210327}},Movements:{"Amount at transition date":{Total:null,Building:null,Cars_in_pool:null,Cars_in_benefit:null},"Increase for new contract":{Total:28901,Building:null,Cars_in_pool:null,Cars_in_benefit:28901},"Revaluation (increase for remeasurement)":{Total:39253,Building:null,Cars_in_pool:39047,Cars_in_benefit:205},"Decrease - Right of Use":{Total:58949,Building:null,Cars_in_pool:14984,Cars_in_benefit:43965},"Decrease - Accumulated Depreciation":{Total:58949,Building:null,Cars_in_pool:14984,Cars_in_benefit:43965},Depreciation:{Total:1695290,Building:1524283,Cars_in_pool:64381,Cars_in_benefit:106626}},Totale:{Totale:{Total:1627137,Building:1524283,Cars_in_pool:25334,Cars_in_benefit:77520}},Closing:{"Right of Use":{Total:18648908,Building:17910324,Cars_in_pool:302499,Cars_in_benefit:436085},"Accumulated Depreciation":{Total:8197322,Building:7621415,Cars_in_pool:272631,Cars_in_benefit:303277},"Net Right of Use":{Total:10451586,Building:10288910,Cars_in_pool:29869,Cars_in_benefit:132807}}}},{Data:{Entity:"prova 1",Scenario:"Prova 1",Period:"November",Year:2022,Currency:"EUR",Opening:{"Right of Use":{Total:888888888,Building:345678987678,Cars_in_pool:567617200,Cars_in_benefit:32422322},"Accumulated Depreciation":{Total:6560981,Building:6097132,Cars_in_pool:999999999,Cars_in_benefit:111111111},"Net Right of Use":{Total:12078722,Building:11813193,Cars_in_pool:899999,Cars_in_benefit:210327}},Movements:{"Amount at transition date":{Total:null,Building:null,Cars_in_pool:null,Cars_in_benefit:null},"Increase for new contract":{Total:28901,Building:null,Cars_in_pool:null,Cars_in_benefit:28901},"Revaluation (increase for remeasurement)":{Total:39253,Building:null,Cars_in_pool:39047,Cars_in_benefit:205},"Decrease - Right of Use":{Total:58949,Building:null,Cars_in_pool:14984,Cars_in_benefit:43965},"Decrease - Accumulated Depreciation":{Total:58949,Building:null,Cars_in_pool:55555555555555,Cars_in_benefit:43965},Depreciation:{Total:1695290,Building:999999999999,Cars_in_pool:64381,Cars_in_benefit:106626}},Totale:{Totale:{Total:1627137,Building:1524283,Cars_in_pool:25334,Cars_in_benefit:77520}},Closing:{"Right of Use":{Total:18648908,Building:17910324,Cars_in_pool:302499,Cars_in_benefit:436085},"Accumulated Depreciation":{Total:8197322,Building:7621415,Cars_in_pool:272631,Cars_in_benefit:303277},"Net Right of Use":{Total:10451586,Building:10288910,Cars_in_pool:29869,Cars_in_benefit:132807}}}},{Data:{Entity:"prova 2",Scenario:"prova 2",Period:"June",Year:2021,Currency:"EUR",Opening:{"Right of Use":{Total:77777777777,Building:17910324,Cars_in_pool:278436,Cars_in_benefit:450944},"Accumulated Depreciation":{Total:6560981,Building:6097132,Cars_in_pool:223233,Cars_in_benefit:240616},"Net Right of Use":{Total:12078722,Building:11813193,Cars_in_pool:55203,Cars_in_benefit:210327}},Movements:{"Amount at transition date":{Total:null,Building:null,Cars_in_pool:null,Cars_in_benefit:null},"Increase for new contract":{Total:28901,Building:null,Cars_in_pool:null,Cars_in_benefit:28901},"Revaluation (increase for remeasurement)":{Total:39253,Building:null,Cars_in_pool:39047,Cars_in_benefit:205},"Decrease - Right of Use":{Total:58949,Building:null,Cars_in_pool:14984,Cars_in_benefit:43965},"Decrease - Accumulated Depreciation":{Total:58949,Building:null,Cars_in_pool:14984,Cars_in_benefit:43965},Depreciation:{Total:1695290,Building:1524283,Cars_in_pool:64381,Cars_in_benefit:106626}},Totale:{Totale:{Total:1627137,Building:1524283,Cars_in_pool:25334,Cars_in_benefit:77520}},Closing:{"Right of Use":{Total:18648908,Building:17910324,Cars_in_pool:302499,Cars_in_benefit:436085},"Accumulated Depreciation":{Total:8197322,Building:7621415,Cars_in_pool:272631,Cars_in_benefit:303277},"Net Right of Use":{Total:10451586,Building:10288910,Cars_in_pool:29869,Cars_in_benefit:132807}}}},{Data:{Entity:"prova 3",Scenario:"prova 3",Period:"Febrary",Year:2020,Currency:"EUR",Opening:{"Right of Use":{Total:6666666666,Building:17910324,Cars_in_pool:278436,Cars_in_benefit:450944},"Accumulated Depreciation":{Total:6560981,Building:6097132,Cars_in_pool:223233,Cars_in_benefit:240616},"Net Right of Use":{Total:12078722,Building:11813193,Cars_in_pool:55203,Cars_in_benefit:210327}},Movements:{"Amount at transition date":{Total:null,Building:null,Cars_in_pool:null,Cars_in_benefit:null},"Increase for new contract":{Total:28901,Building:null,Cars_in_pool:null,Cars_in_benefit:28901},"Revaluation (increase for remeasurement)":{Total:39253,Building:null,Cars_in_pool:39047,Cars_in_benefit:205},"Decrease - Right of Use":{Total:58949,Building:null,Cars_in_pool:14984,Cars_in_benefit:43965},"Decrease - Accumulated Depreciation":{Total:58949,Building:null,Cars_in_pool:14984,Cars_in_benefit:43965},Depreciation:{Total:1695290,Building:1524283,Cars_in_pool:64381,Cars_in_benefit:106626}},Totale:{Totale:{Total:1627137,Building:1524283,Cars_in_pool:25334,Cars_in_benefit:77520}},Closing:{"Right of Use":{Total:18648908,Building:17910324,Cars_in_pool:302499,Cars_in_benefit:436085},"Accumulated Depreciation":{Total:8197322,Building:7621415,Cars_in_pool:272631,Cars_in_benefit:303277},"Net Right of Use":{Total:10451586,Building:10288910,Cars_in_pool:29869,Cars_in_benefit:132807}}}}]},createSorter:function(){return new n("description",false)},_createFiltersModel:function(){let e=new t({Entity:null,Anno:null,Periodo:null,CompanyCode:null});this.getView().setModel(e,"oFiltersModel")},_elaboratedMonths:function(e){const t=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return e.map(e=>parseInt(e,10)).sort((e,t)=>e-t).map(e=>({ID:e.toString().padStart(3,"0"),description:t[e-1]}))},_sortEntitiesByDescription:function(e){return e.sort((e,t)=>e.description.localeCompare(t.description))},_elaborateEntities:function(e,t){const i=e.map((e,i)=>({ID:e,description:t[i]}));return this._sortEntitiesByDescription(i)},_sortStringArray:function(e){return e.sort((e,t)=>e.localeCompare(t))},_getDataFilters:function(){const e=`${this.osUrl}Filters`;axios.post(e).then(e=>{console.log(e.data);let t=this.getView().getModel("oFiltersModel");t.setData({Entity:this._elaborateEntities(e.data.BUKRS,e.data.BUTXT),Periodo:this._elaboratedMonths(e.data.PERIODDUEDATE),Anno:this._sortStringArray(e.data.YEARDUEDATE)});console.log("Filters data: ",t.getData());return}).catch(e=>{console.error(e);if(e.response){console.error("Server responded with error: ",e.response.status,e.response.data)}else if(e.request){console.error("No response received from server: ",e.request)}else{console.error("Axios error: ",e.message)}})},getTableData:function(){this.getView().byId("table").setBusy(true);let e=this.getView().getModel("selectedFiltersModel").getData();let t=this.getView().getModel("selectedFiltersModel");console.log(Object.values(e.entity));const i={entity:Object.values(e.entity),year:e.year,period:e.period};const o=`${this.osUrl}GetTabellaFiltrata9`;axios.post(o,i).then(e=>{this.getView().byId("table").setBusy(false);t.setProperty("/matchData",true);console.log(e.data);let i=this.getView().getModel("DataIMA9");if(typeof e.data==="object"){let t=[];t.push(e.data);if(t&&Array.isArray(t)){let e=t[0].value.map(this.convertExponentialValues);i.setData(e);i.refresh()}}else{i.setData(e.data);i.refresh()}return}).catch(e=>{console.error(e);if(e.response){console.error("Server responded with error: ",e.response.status,e.response.data)}else if(e.request){console.error("No response received from server: ",e.request)}else{console.error("Axios error: ",e.message)}})},convertExponentialValues:function(e){for(let t in e){if(e.hasOwnProperty(t)){if(typeof e[t]==="string"&&e[t].match(/^-?\d+\.?\d*e[+\-]?\d+$/i)){let i=parseFloat(e[t]);if(!isNaN(i)){e[t]=i.toLocaleString("it-IT",{minimumFractionDigits:2,maximumFractionDigits:2})}}}}return e},onSelectionChange:function(e){this.assignReportResume(e);this.makeTitleObjAttrBold();let t=this.getView().getModel("selectedFiltersModel");let i=t.getData();const o=e.getSource();const n=o.getName();console.log("selected control",o);console.log("control name",n);if(o.getMetadata().getName()==="sap.m.MultiComboBox"){i[n]=o.getSelectedKeys()}else{i[n]=o.getSelectedKey()}t.setData(i);let a=i.Periodo&&i.Anno&&(i.Entity&&i.Entity.length>0)?true:false;t.setProperty("/allSelected",a);this.clearFilter(e);this.selectFiltering()},clearFilter:function(e){let t=this.getView().getModel("selectedFiltersModel");let i=t.getData();const o=e.getSource();const n=o.getName();let a=i[n]||[];console.log("vecchie chiavi",a);switch(n){case"Entity":if(this.entityKeys==undefined){let e=o.getSelectedKeys();this.entityKeys=e.length}else{const t=[this.getView().byId("AnnoSelect"),this.getView().byId("PeriodoSelect")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}this.assignReportResume(e,t.getLabels()[0].getText().toLowerCase(),t);this.makeTitleObjAttrBold()})}break;case"Anno":if(this.annoKey==undefined){let e=o.getSelectedKey();this.annoKey=e}else{const t=[this.getView().byId("PeriodoSelect")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}this.assignReportResume(e,t.getLabels()[0].getText().toLowerCase(),t);this.makeTitleObjAttrBold()})}break;case"Periodo":if(this.periodoKey==undefined){let e=o.getSelectedKey();this.periodoKey=e}else{const t=[];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}this.assignReportResume(e,t.getLabels()[0].getText().toLowerCase(),t);this.makeTitleObjAttrBold()})}break;default:console.error("default, errore nello switch");break}},selectFiltering:function(){const e=`${this.osUrl}applyFilters9`;let t=this.getView().getModel("selectedFiltersModel").getData();console.log(Object.values(t.entity));const i={entity:Object.values(t.entity),year:t.year,period:t.period};axios.post(e,i).then(e=>{console.log("dati filtrati test",e.data);let t=this.getView().getModel("oFiltersModel");if(!i.year){t.getData().Anno=this._sortStringArray(e.data.YEARDUEDATE);t.getData().Periodo=this._elaboratedMonths(e.data.PERIODDUEDATE)}if(!i.period){t.getData().Periodo=this._elaboratedMonths(e.data.PERIODDUEDATE)}console.log(t.getData().Entity);t.refresh();console.log("Filters data: ",t.getData());return}).catch(e=>{console.error(e);if(e.response){console.error("Server responded with error: ",e.response.status,e.response.data)}else if(e.request){console.error("No response received from server: ",e.request)}else{console.error("Axios error: ",e.message)}})},setEnabledDownload:function(e){const t=this.getView().byId("excelBtn");const i=this.getView().byId("pdfBtn");t.setEnabled(e);i.setEnabled(e)},disableFilterStart:function(e){const t=this.getView().byId("filterbar");const i=t._getSearchButton();if(i){i.setEnabled(false)}},makeTitleObjAttrBold:function(){const e=document.querySelectorAll(".sapFDynamicPageHeaderContent .sapUiVltCell.sapuiVltCell span");e.forEach(e=>{if(e&&e.textContent.includes(":")){const t=e.textContent.split(":");const i=document.createElement("span");i.style.fontWeight="bold";i.textContent=t[0]+": ";const o=document.createTextNode(t[1].trim());e.textContent="";e.appendChild(i);e.appendChild(o)}})},assignReportResume:function(e,t,i){const n=e.getSource();const a=n?n.getLabels()[0].getText():"";let l="";let r="";if(n.getMetadata().getName()==="sap.m.MultiComboBox"){if(i!==undefined&&i.getMetadata().getName()==="sap.m.MultiComboBox"){r=i.getSelectedKeys().map(e=>e.getText()).join(", ")}else{l=n.getSelectedItems().map(e=>e.getText()).join(", ")}}else if(n.getMetadata().getName()==="sap.m.Select"){if(i!==undefined&&i.getMetadata().getName()==="sap.m.Select"){const e=i.getSelectedItem();r=e?e.getText():""}else{const e=n.getSelectedItem();l=e?e.getText():""}}else if(n.getMetadata().getName()==="sap.m.ComboBox"){if(i!==undefined&&i.getMetadata().getName()==="sap.m.ComboBox"){const e=i.getSelectedItem();r=e?e.getText():""}else{const e=n.getSelectedItem();l=e?e.getText():""}}const s=this.getView().byId("hLayout");const c=s.getContent();c.forEach(e=>{const i=e.getContent();i.forEach(e=>{if(e instanceof o){if(e.getTitle().toLowerCase()===a.toLowerCase()){e.setText(l);e.rerender()}else if(e.getTitle().toLowerCase()===t){e.setText(r);e.rerender()}}})})},onCloseLegend:function(e){var t=this.byId("legendPanel");t.setVisible(false)},_initializeFilters:function(){console.log("Filters data: ",this.getView().getModel("oFiltersModel"))},_matchData:function(){let e=this.getView().getModel("selectedFiltersModel").getData();this.getView().setModel(new t,"DataIMA9");var i=[];this.getView().getModel("DataIMA9").setData(i);this.getView().getModel("DataIMA9").refresh();console.log(this.getView().getModel("DataIMA9"))},onSearch:function(){this.getTableData();const e=this.getTableMockData();const i=this.getView().getModel("selectedFiltersModel").getData().allSelected;var o=this.byId("table");if(i){this.makeGeneratedTableMockData(e);this.setTableHeight(null,o)}else{var n=new t({rows:[]});o.setModel(n);o.bindRows("/rows")}},makeGeneratedTableMockData:function(e){var i=this.byId("table");const o=this._prepareData(e[0].Data);i.removeAllColumns();const n=[{key:"Section",label:"Section",width:"150px",freeze:true},{key:"Description",label:"Description",width:"350px",freeze:true},{key:"Total",label:"Total",width:"150px"},{key:"Building",label:"Building",width:"150px"},{key:"Cars_in_pool",label:"Cars_in_pool",width:"150px"},{key:"Cars_in_benefit",label:"Cars_in_benefit",width:"150px"}];n.forEach(e=>{i.addColumn(new sap.ui.table.Column({label:new sap.m.Label({text:e.label}),template:new sap.m.Text({text:"{"+e.key+"}"}),width:e.width,sorted:false,filtered:false,freezed:e.freeze}))});const a=new t({rows:o});a.setSizeLimit(o.length+100);i.setModel(a);i.bindRows("/rows");const l=Math.min(o.length,20);i.setVisibleRowCount(l);this.getView().getModel("selectedFiltersModel").setProperty("/matchData",true);this._colorTotalRows();console.log("Table found:",!!i,"Table ID:",i?.getId())},_prepareData:function(e){var t=[];var i="";var o={Opening:["Right of Use","Accumulated Depreciation","Net Right of Use",""],Movements:["Amount at transition date","Increase for new contract","Revaluation (increase for remeasurement)","Decrease - Right of Use","Decrease - Accumulated Depreciation","Increase for Mergers - Right of Use","Increase for Mergers - Accumulated Depreciation","Decrease for Mergers - Right of Use","Decrease for Mergers - Accumulated Depreciation","Reverse for Change CDC - Right of Use","Recognition for Change CDC - Right of Use","Reverse for Change CDC - Accumulated Depreciation","Recognition for Change CDC - Accumulated Depreciation","Depreciation"],Totale:["Totale",""],Closing:["Right of Use","Accumulated Depreciation","Net Right of Use"]};Object.keys(o).forEach(function(n){o[n].forEach(function(o){var a=e[n]||{};var l=a[o]||{};const r=e=>{if(e===undefined||e===null)return"-";if(typeof e==="number"){return e.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}return e};t.push({Section:n===i?"":n,Description:o,Total:r(l.Total),Building:r(l.Building),Cars_in_pool:r(l["Cars_in_pool"]),Cars_in_benefit:r(l["Cars_in_benefit"])});i=n})});return t},_createColumns:function(e){var t=this.byId("table");var i=new Set;Object.keys(e[0]||{}).forEach(e=>{if(!i.has(e)){this._addColumn(e);i.add(e)}})},_addColumn:function(e){var t=this.byId("table");var i=new sap.ui.table.Column({label:new sap.m.Label({text:e}),template:new sap.m.Text({text:"{"+e+"}"}),width:"11rem"});t.addColumn(i)},setTableHeight:function(e,t){let i=window.innerHeight;let o=window.innerWidth;if(o<450){let e=Math.floor(i/100);t.setVisibleRowCount(e)}else{let e=Math.floor(i/80);t.setVisibleRowCount(e)}},_colorTotalRows:function(){var e=this.byId("table");var t=function(e){i()};var i=function(){var t=e.getRows();t.forEach(function(e){var t=e.getBindingContext();var i=e._mDomRefs.jQuery.row[1];var o=e._mDomRefs.jQuery.row[0];if(t&&(i||o)){var n=t.getProperty("Description");var a=n==="";if(a){$(i).addClass("highlightRow");$(o).addClass("highlightRow")}else{$(i).removeClass("highlightRow");$(o).removeClass("highlightRow")}}})};e.attachEvent("rowsUpdated",t);i();this.getView().byId("table").setBusy(false)},_bindToolbarText:function(){let e=this.getView().getModel("selectedFiltersModel").getData();let t=`Scenario: ${e.scenario||"-"} - Period: ${e.period||"-"} - Year: ${e.year||"-"} - Entity: ${e.entity||"-"}`},onDownloadExcelPress:function(){var e=this.byId("table");var t=e.getModel();var o=e.getBinding("rows").oList;var n=this._createColumnConfig();var a={workbook:{columns:n,context:{sheetName:"Exported Data"},styles:[{id:"header",width:"200px",fontSize:12,fontColor:"#ffffff",backgroundColor:"#808080",bold:true,hAlign:"Center",border:{top:{style:"thin",color:"#000000"},bottom:{style:"thin",color:"#000000"},left:{style:"thin",color:"#000000"},right:{style:"thin",color:"#000000"}}},{id:"content",width:"200px",fontSize:10,hAlign:"Left",border:{top:{style:"thin",color:"#000000"},bottom:{style:"thin",color:"#000000"},left:{style:"thin",color:"#000000"},right:{style:"thin",color:"#000000"}}}]},dataSource:o,fileName:"ExportedData.xlsx",worker:false};var l=new i(a);l.build().then(function(){sap.m.MessageToast.show("Excel export successful!")}).finally(function(){l.destroy()})},onDownloadPdfPress:function(){var e=this.byId("table");var t=e.getBinding("rows");var i=t.getContexts().map(function(e){return e.getObject()});var o=["Section","Description","Total","Building","Cars_in_pool","Cars_in_benefit"];var n={pageSize:"A4",pageOrientation:"landscape",pageMargins:[5,5,5,5],footer:{text:(new Date).toLocaleString(),alignment:"right",fontSize:6},content:[]};let a=[];a.push(o.map(e=>({text:e.replace(/_/g," "),style:{fontSize:8,bold:true,alignment:"center"},noWrap:true})));i.forEach(function(e){let t=o.map(t=>({text:String(e[t]||"-").substring(0,20),style:{fontSize:8},noWrap:true}));a.push(t)});n.content.push({table:{headerRows:1,widths:Array(o.length).fill(90),body:a},layout:{paddingLeft:function(){return 2},paddingRight:function(){return 2},paddingTop:function(){return 2},paddingBottom:function(){return 2}}});pdfMake.createPdf(n).download()},_createColumnConfig:function(){var e=this.byId("table");var t=e.getColumns();return t.map(e=>({label:e.getLabel().getText(),property:e.getLabel().getText(),type:"string"}))}})});
//# sourceMappingURL=Homepage.controller.js.map