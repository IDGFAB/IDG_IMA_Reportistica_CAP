sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/export/Spreadsheet","sap/ui/thirdparty/jquery","sap/m/ObjectAttribute","sap/ui/model/Sorter"],function(t,e,o,jQuery,a,r){"use strict";return t.extend("imareport22.controller.Homepage",{onInit:function(){this.getView().setModel(new e,"selectedFiltersModel");this._initializeFilters();this.osUrl=this.getOwnerComponent().getModel().sServiceUrl;this._createFiltersModel();this._getDataFilters();this.getView().setModel(new e,"DataIMA22");let t=this.getView().getModel("selectedFiltersModel");t.setProperty("/matchData",false);this.entityKeys;this.typeContractKeys;this.contractKeys;this.cdcKeys;this.annoKey;this.periodoKey;this.idStoricoKey},onAfterRendering:function(){this.makeTitleObjAttrBold();this.disableFilterStart();console.clear()},createSorter:function(){return new r("description",false)},_createFiltersModel:function(){let t=new e({Entity:null,TipoContratto:null,Contratto:null,Anno:null,Periodo:null,CostCenter:null,Id_storico:null,CompanyCode:null});this.getView().setModel(t,"oFiltersModel")},_elaboratedMonths:function(t){const e=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return t.map(t=>parseInt(t,10)).sort((t,e)=>t-e).map(t=>({ID:t.toString().padStart(3,"0"),description:e[t-1]}))},convertModelStringToNumericValues(){function t(t,e){let o=t.toString();while(o.length<e){o="0"+o}return o}var e=this.getView().getModel("DataIMA22");var o=e.getData();const a=["RIGHT_OF_USE","ACCUMULATED_DEPRECIATION","NET_RIGHT_OF_USE","CLOSING_LEASES_LIABILITIES","LEASE_LIABILITIES_SHORT_TERM","LEASE_LIABILITIES_LONG_TERM","YTD_INTEREST","LEASE_COST","DEPRECIATION","GAIN_FX_RATES","LOSS_FX_RATES"];o=o.map(t=>{const e=t=>t.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,",");a.forEach(o=>{if(t[o]){const a=String(t[o]);const r=parseFloat(a.replace(/\./g,"").replace(/,/g,"."));t[o]=r;t[o+"_DISPLAY"]=e(a.startsWith("0,")?parseFloat(a.replace(/,/g,"0.")):parseFloat(a.replace(/\./g,"").replace(/,/g,".")))}});return t});e.setData(o);e.refresh()},onTableSort:function(t){const e=t.getParameter("column");const o=e.getSortProperty();const a=t.getParameter("sortOrder")==="Descending";const s=new r(o,a);this.byId("table").getBinding("rows").sort(s)},_sortEntitiesByDescription:function(t){return t.sort((t,e)=>t.description.localeCompare(e.description))},_elaborateEntities:function(t,e){const o=t.map((t,o)=>({ID:t,description:e[o]}));return this._sortEntitiesByDescription(o)},_sortStringArray:function(t){return t.sort((t,e)=>t.localeCompare(e))},_getDataFilters:function(){const t=`${this.osUrl}Filters`;axios.post(t).then(t=>{let e=this.getView().getModel("oFiltersModel");e.setData({Entity:this._elaborateEntities(t.data.BUKRS,t.data.BUTXT),TipoContratto:this._sortStringArray(t.data.RECNTYPE),Contratto:this._sortStringArray(t.data.RECNNR),Periodo:this._elaboratedMonths(t.data.PERIODDUEDATE),Anno:this._sortStringArray(t.data.YEARDUEDATE),CostCenter:this._sortStringArray(t.data.CDC),Id_storico:this._sortStringArray(t.data.ID_STORICO)});return}).catch(t=>{console.error(t);if(t.response){console.error("Server responded with error: ",t.response.status,t.response.data)}else if(t.request){console.error("No response received from server: ",t.request)}else{console.error("Axios error: ",t.message)}})},getTableData:function(){this.getView().byId("table").setBusy(true);let t=this.getView().getModel("selectedFiltersModel").getData();let e=this.getView().getModel("selectedFiltersModel");const o={entity:Object.values(t.entity),tipoContratto:Object.values(t.tipoContratto),contratto:t.contratto?Object.values(t.contratto):null,year:t.year,period:t.period,costCenter:t.costCenter?Object.values(t.costCenter):null,Id_storico:t.ID_STORICO};const a=`${this.osUrl}GetTabellaFiltrata`;axios.post(a,o).then(t=>{this.getView().byId("table").setBusy(false);e.setProperty("/matchData",true);let o=this.getView().getModel("DataIMA22");if(typeof t.data==="object"){let e=[];e.push(t.data);if(e&&Array.isArray(e)){let t=e[0].value.map(this.convertExponentialValues);o.setData(t);o.refresh();this.convertModelStringToNumericValues()}}else{o.setData(t.data);o.refresh()}return}).catch(t=>{console.error(t);if(t.response){console.error("Server responded with error: ",t.response.status,t.response.data)}else if(t.request){console.error("No response received from server: ",t.request)}else{console.error("Axios error: ",t.message)}})},convertExponentialValues:function(t){for(let e in t){if(t.hasOwnProperty(e)){if(typeof t[e]==="string"&&t[e].match(/^-?\d+\.?\d*e[+\-]?\d+$/i)){let o=parseFloat(t[e]);if(!isNaN(o)){t[e]=o.toLocaleString("it-IT",{minimumFractionDigits:2,maximumFractionDigits:2})}}}}return t},onSelectionChange:function(t){this.assignReportResume(t);this.makeTitleObjAttrBold();let e=this.getView().getModel("selectedFiltersModel");let o=e.getData();const a=t.getSource();const r=a.getName();if(a.getMetadata().getName()==="sap.m.MultiComboBox"){o[r]=a.getSelectedKeys()}else{o[r]=a.getSelectedKey()}this.clearFilter(t);e.setData(o);e.refresh();let s=o.Periodo&&o.Anno&&o.ID_STORICO&&(o.TipoContratto&&o.TipoContratto.length>0)&&(o.Entity&&o.Entity.length>0)?true:false;e.setProperty("/allSelected",s);this.selectFiltering()},clearFilter:function(t){let e=this.getView().getModel("selectedFiltersModel");let o=e.getData();const a=t.getSource();const r=a.getName();let s=o[r]||[];let n;switch(r){case"ID_STORICO":n=a.getSelectedKey().length;n=true;if(n){o.Periodo=null;o.CostCenter=null;o.Entity=null;o.TipoContratto=null;o.Contratto=null;e.refresh();const t=[this.getView().byId("TipoContrattoBox"),this.getView().byId("ContrattoBox"),this.getView().byId("AnnoSelect"),this.getView().byId("PeriodoSelect"),this.getView().byId("CostCenterBox"),this.getView().byId("EntityBox")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}const e=t.getLabels()[0].getText().toLowerCase();this.assignReportResume({getSource:()=>t},e,null);this.makeTitleObjAttrBold()});e.setProperty("/allSelected",false)}break;case"Anno":n=a.getSelectedKey().length;n=true;if(n){o.Periodo=null;o.CostCenter=null;o.Entity=null;o.TipoContratto=null;o.Contratto=null;e.refresh();const t=[this.getView().byId("TipoContrattoBox"),this.getView().byId("ContrattoBox"),this.getView().byId("PeriodoSelect"),this.getView().byId("CostCenterBox"),this.getView().byId("EntityBox")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}const o=t.getLabels()[0].getText().toLowerCase();this.assignReportResume({getSource:()=>t},o,null);this.makeTitleObjAttrBold();e.setProperty("/allSelected",false)})}break;case"Periodo":n=a.getSelectedKey().length;n=true;if(n){o.CostCenter=null;o.Entity=null;o.TipoContratto=null;o.Contratto=null;e.refresh();const t=[this.getView().byId("TipoContrattoBox"),this.getView().byId("ContrattoBox"),this.getView().byId("CostCenterBox"),this.getView().byId("EntityBox")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}const o=t.getLabels()[0].getText().toLowerCase();this.assignReportResume({getSource:()=>t},o,null);this.makeTitleObjAttrBold();e.setProperty("/allSelected",false)})}break;case"Entity":n=a.getSelectedKeys().length;n=true;if(n){o.TipoContratto=null;o.Contratto=null;o.CostCenter=null;e.refresh();const t=[this.getView().byId("TipoContrattoBox"),this.getView().byId("ContrattoBox"),this.getView().byId("CostCenterBox")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}const o=t.getLabels()[0].getText().toLowerCase();this.assignReportResume({getSource:()=>t},o,null);this.makeTitleObjAttrBold();e.setProperty("/allSelected",false)})}break;case"CostCenter":n=a.getSelectedKeys().length;n=true;if(n){o.TipoContratto=null;o.Contratto=null;e.refresh();const t=[this.getView().byId("TipoContrattoBox"),this.getView().byId("ContrattoBox")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}const o=t.getLabels()[0].getText().toLowerCase();this.assignReportResume({getSource:()=>t},o,null);this.makeTitleObjAttrBold();e.setProperty("/allSelected",false)})}break;case"TipoContratto":n=a.getSelectedKeys().length;n=true;if(n){const t=[this.getView().byId("ContrattoBox")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}const o=t.getLabels()[0].getText().toLowerCase();this.assignReportResume({getSource:()=>t},o,null);this.makeTitleObjAttrBold();e.setProperty("/allSelected",false)})}break;case"Contratto":break;default:console.error("default, errore nello switch");break}},selectFiltering:function(){const t=`${this.osUrl}applyFilters`;let e=this.getView().getModel("selectedFiltersModel").getData();const o={Id_storico:e.ID_STORICO,year:e.year,period:e.period,entity:e.entity?Object.values(e.entity):null,costCenter:e.costCenter?Object.values(e.costCenter):null,tipoContratto:e.tipoContratto?Object.values(e.tipoContratto):null,contratto:e.contratto?Object.values(e.contratto):null};axios.post(t,o).then(t=>{let e=this.getView().getModel("oFiltersModel");if(!o.year){e.getData().Anno=this._sortStringArray(t.data.YEARDUEDATE);e.getData().Periodo=this._elaboratedMonths(t.data.PERIODDUEDATE);e.getData().Entity=this._elaborateEntities(t.data.BUKRS,t.data.BUTXT);e.getData().CostCenter=this._sortStringArray(t.data.CDC);e.getData().TipoContratto=this._sortStringArray(t.data.RECNTYPE);e.getData().Contratto=this._sortStringArray(t.data.RECNNR)}if(!o.period){e.getData().Periodo=this._elaboratedMonths(t.data.PERIODDUEDATE);e.getData().Entity=this._elaborateEntities(t.data.BUKRS,t.data.BUTXT);e.getData().CostCenter=this._sortStringArray(t.data.CDC);e.getData().TipoContratto=this._sortStringArray(t.data.RECNTYPE);e.getData().Contratto=this._sortStringArray(t.data.RECNNR)}if(!o.entity||o.entity.length==0){e.getData().Entity=this._elaborateEntities(t.data.BUKRS,t.data.BUTXT);e.getData().CostCenter=this._sortStringArray(t.data.CDC);e.getData().TipoContratto=this._sortStringArray(t.data.RECNTYPE);e.getData().Contratto=this._sortStringArray(t.data.RECNNR)}if(!o.costCenter||o.costCenter.length==0){e.getData().CostCenter=this._sortStringArray(t.data.CDC);e.getData().Contratto=this._sortStringArray(t.data.RECNNR);if(!o.tipoContratto){e.getData().TipoContratto=this._sortStringArray(t.data.RECNTYPE)}}if(!o.tipoContratto||o.tipoContratto.length==0){e.getData().TipoContratto=this._sortStringArray(t.data.RECNTYPE);e.getData().Contratto=this._sortStringArray(t.data.RECNNR)}if(!o.contratto||o.contratto.length==0){e.getData().Contratto=this._sortStringArray(t.data.RECNNR)}e.refresh();return}).catch(t=>{console.error(t);if(t.response){console.error("Server responded with error: ",t.response.status,t.response.data)}else if(t.request){console.error("No response received from server: ",t.request)}else{console.error("Axios error: ",t.message)}})},setEnabledDownload:function(t){const e=this.getView().byId("excelBtn");const o=this.getView().byId("pdfBtn");e.setEnabled(t);o.setEnabled(t)},disableFilterStart:function(t){const e=this.getView().byId("filterbar");const o=e._getSearchButton();if(o){o.setEnabled(false)}},makeTitleObjAttrBold:function(){const t=document.querySelectorAll(".sapFDynamicPageHeaderContent .sapUiVltCell.sapuiVltCell span");t.forEach(t=>{if(t&&t.textContent.includes(":")){const e=t.textContent.split(":");const o=document.createElement("span");o.style.fontWeight="bold";o.textContent=e[0]+": ";const a=document.createTextNode(e[1].trim());t.textContent="";t.appendChild(o);t.appendChild(a)}})},assignReportResume:function(t,e,o){const r=t.getSource();const s=r?r.getLabels()[0].getText():"";const n=t=>{if(!t)return"";switch(t.getMetadata().getName()){case"sap.m.MultiComboBox":return t.getSelectedKeys().map(t=>typeof t==="object"?t.getText():t).join(", ");case"sap.m.Select":case"sap.m.ComboBox":const e=t.getSelectedItem();return e?e.getText():"";default:return""}};const i=o?n(o):n(r);const l=this.getView().byId("hLayout");l.getContent().forEach(t=>{t.getContent().forEach(t=>{if(!(t instanceof a))return;const o=t.getTitle().toLowerCase();const r=o===s.toLowerCase()||o===e;if(r&&i!==undefined){t.setText(i);t.rerender()}})})},onCloseLegend:function(t){var e=this.byId("legendPanel");e.setVisible(false)},_initializeFilters:function(){},_matchData:function(){let t=this.getView().getModel("selectedFiltersModel").getData();this.getView().setModel(new e,"DataIMA22");var o=[];this.getView().getModel("DataIMA22").setData(o);this.getView().getModel("DataIMA22").refresh()},onSearch:function(){this.getTableData()},_loadData:function(t){var o=this.byId("table");if(t){var a=this._prepareData(t.getData().Leases);var r=new e({rows:a});o.setModel(r);o.bindRows("/rows");this._createColumns(a);this._colorTotalRows();this.setTableHeight(null,o)}},_prepareData:function(t){var e=[];var o="";for(const a in t){if(Array.isArray(t[a])){t[a].forEach(t=>{let r={Category:a===o?"":a};o=a;for(let e in t){r[e]=t[e]===null?"-":t[e]}e.push(r)})}else if(a==="Summary"){let r=t[a];for(const t in r){let a={Category:t===o?"":t};let s=r[t];o=t;for(let t in s){a[t]=s[t]===null?"-":s[t]}a["_isTotal"]=true;e.push(a)}}}return e},_createColumns:function(t){var e=this.byId("table");var o=new Set;Object.keys(t[0]||{}).forEach(t=>{if(!o.has(t)){this._addColumn(t);o.add(t)}})},_addColumn:function(t){var e=this.byId("table");var o=new sap.ui.table.Column({label:new sap.m.Label({text:t}),template:new sap.m.Text({text:"{"+t+"}"}),width:"11rem"});e.addColumn(o)},setTableHeight:function(t,e){let o=window.innerHeight;let a=window.innerWidth;if(a<450){let t=Math.floor(o/100);e.setVisibleRowCount(t)}else{let t=Math.floor(o/80);e.setVisibleRowCount(t)}},_colorTotalRows:function(){var t=this.byId("table");var e=function(){var e=t.getRows();e.forEach(function(t){var e=t.getBindingContext();var o=t._mDomRefs.jQuery.row[1];var a=t._mDomRefs.jQuery.row[0];if(e&&(o||a)){var r=e.getProperty("Category");var s=e.getProperty("_isTotal");if(r==="Total"&&s===true){$(o).addClass("highlightRow");$(a).addClass("highlightRow")}else{$(o).removeClass("highlightRow");$(a).removeClass("highlightRow")}}})};t.attachEvent("rowsUpdated",e);e()},_bindToolbarText:function(){let t=this.getView().getModel("selectedFiltersModel").getData();let e=`Scenario: ${t.scenario||"-"} - Period: ${t.period||"-"} - Year: ${t.year||"-"} - Entity: ${t.entity||"-"}`},onDownloadExcelPress:function(){var t=this.byId("table");var e=t.getModel();var a=t.getBinding("rows").oList;var r=this._createColumnConfig();var s={workbook:{columns:r,context:{sheetName:"Exported Data"},styles:[{id:"header",fontSize:12,fontColor:"#ffffff",backgroundColor:"#808080",bold:true,hAlign:"Center",border:{top:{style:"thin",color:"#000000"},bottom:{style:"thin",color:"#000000"},left:{style:"thin",color:"#000000"},right:{style:"thin",color:"#000000"}}},{id:"content",fontSize:10,hAlign:"Left",border:{top:{style:"thin",color:"#000000"},bottom:{style:"thin",color:"#000000"},left:{style:"thin",color:"#000000"},right:{style:"thin",color:"#000000"}}}]},dataSource:a,fileName:"ExportedData.xlsx",worker:false};var n=new o(s);n.build().then(function(){sap.m.MessageToast.show("Excel export successful!")}).finally(function(){n.destroy()})},onDownloadPdfPress:function(){var t=this.byId("table");var e=t.getBinding("rows");let o=e.getContexts().map(function(t){return t.getObject()});const a=[{name:"Asset Class",width:60,technical:"ASSET_CLASS"},{name:"Intercompany",width:40,technical:"INTERCOMPANY"},{name:"Cost Centre",width:45,technical:"CDC"},{name:"CC Description",width:60,technical:"CDC_CODE"},{name:"Lease Number",width:45,technical:"LEASE_N"},{name:"Contract Code",width:50,technical:"CONTRACT_CODE"},{name:"Business Area",width:45,technical:"ACC_SECTOR"},{name:"Contract Description",width:80,technical:"CONTRACT_DESCRIPTION"},{name:"Merged Entity",width:45,technical:"MERGED_ENTITY"},{name:"Right of Use",width:50,technical:"RIGHT_OF_USE"},{name:"Accumulated Depr.",width:55,technical:"ACCUMULATED_DEPRECIATION"},{name:"Net Right of Use",width:50,technical:"NET_RIGHT_OF_USE"},{name:"Closing Leases Liabilities",width:60,technical:"CLOSING_LEASES_LIABILITIES"},{name:"Lease Liabilities Short Term",width:60,technical:"LEASE_LIABILITIES_SHORT_TERM"},{name:"Lease Liabilities Long Term",width:60,technical:"LEASE_LIABILITIES_LONG_TERM"},{name:"YTD Interest",width:45,technical:"YTD_INTEREST"},{name:"Lease Cost",width:45,technical:"LEASE_COST"},{name:"Depreciation",width:45,technical:"DEPRECIATION"},{name:"Gain FX Rates",width:45,technical:"GAIN_FX_RATES"},{name:"Loss FX Rates",width:45,technical:"LOSS_FX_RATES"}];var r={pageSize:"A3",pageOrientation:"landscape",pageMargins:[5,5,5,5],footer:{text:(new Date).toLocaleString(),alignment:"right",fontSize:6},content:[]};let s=[];s.push(a.map(t=>({text:t.name.substring(0,20),style:{fontSize:6,bold:true,alignment:"center"},noWrap:true,fillColor:"#d9d9d9",border:[true,false,true,true]})));o.forEach(function(t){let e=a.map(e=>({text:String(t[e.technical]||"-").substring(0,60),style:{fontSize:6},noWrap:false,border:[true,false,true,false]}));s.push(e)});r.content.push({table:{headerRows:1,widths:a.map(t=>t.width),body:s},layout:{hLineWidth:function(){return 1},vLineWidth:function(){return 1},paddingLeft:function(){return 2},paddingRight:function(){return 2},paddingTop:function(){return 2},paddingBottom:function(){return 2}}});pdfMake.createPdf(r).download()},_createColumnConfig:function(){return this.byId("table").getColumns().map(function(t){const e=t.getMultiLabels();let o={label:"",property:"",type:"string"};if(!e||!e.length){const e=t.getLabel();const a=e?e.getText():"";o.label=a;o.property=a}else{const t=e.length>1?e[1]:e[0];o.label=t.getText();o.property=t.getCustomData()[0]?.getValue()||t.getText()}return o})}})});
//# sourceMappingURL=Homepage.controller.js.map