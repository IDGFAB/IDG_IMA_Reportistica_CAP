sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/export/Spreadsheet","sap/ui/thirdparty/jquery","sap/m/ObjectAttribute","sap/ui/model/Sorter"],function(e,t,o,jQuery,r,a){"use strict";return e.extend("imareport22.controller.Homepage",{onInit:function(){this.getView().setModel(new t,"selectedFiltersModel");this._initializeFilters();this.osUrl=this.getOwnerComponent().getModel().sServiceUrl;this._createFiltersModel();this._getDataFilters();this.getView().setModel(new t,"DataIMA22");let e=this.getView().getModel("selectedFiltersModel");e.setProperty("/matchData",false)},createSorter:function(){return new a("description",false)},_createFiltersModel:function(){let e=new t({Entity:null,TipoContratto:null,Contratto:null,Anno:null,Periodo:null,CostCenter:null,Id_storico:null,CompanyCode:null});this.getView().setModel(e,"oFiltersModel")},_elaboratedMonths:function(e){const t=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return e.map(e=>parseInt(e,10)).sort((e,t)=>e-t).map(e=>({ID:e.toString().padStart(3,"0"),description:t[e-1]}))},_sortEntitiesByDescription:function(e){return e.sort((e,t)=>e.description.localeCompare(t.description))},_elaborateEntities:function(e,t){const o=e.map((e,o)=>({ID:e,description:t[o]}));return this._sortEntitiesByDescription(o)},_sortStringArray:function(e){return e.sort((e,t)=>e.localeCompare(t))},_getDataFilters:function(){const e=`${this.osUrl}Filters`;axios.post(e).then(e=>{console.log(e.data);let t=this.getView().getModel("oFiltersModel");t.setData({Entity:this._elaborateEntities(e.data.BUKRS,e.data.BUTXT),TipoContratto:this._sortStringArray(e.data.RECNTYPE),Contratto:this._sortStringArray(e.data.RECNNR),Periodo:this._elaboratedMonths(e.data.PERIODDUEDATE),Anno:this._sortStringArray(e.data.YEARDUEDATE),CostCenter:this._sortStringArray(e.data.CDC),Id_storico:this._sortStringArray(e.data.ID_STORICO)});console.log("Filters data: ",t.getData());return}).catch(e=>{console.error(e);if(e.response){console.error("Server responded with error: ",e.response.status,e.response.data)}else if(e.request){console.error("No response received from server: ",e.request)}else{console.error("Axios error: ",e.message)}})},getTableData:function(){this.getView().byId("table").setBusy(true);let e=this.getView().getModel("selectedFiltersModel").getData();let t=this.getView().getModel("selectedFiltersModel");console.log(Object.values(e.entity));const o={entity:Object.values(e.entity),tipoContratto:Object.values(e.tipoContratto),contratto:e.contratto?Object.values(e.contratto):null,year:e.year,period:e.period,costCenter:e.costCenter?Object.values(e.costCenter):null,Id_storico:e.ID_STORICO};const r=`${this.osUrl}GetTabellaFiltrata`;axios.post(r,o).then(e=>{this.getView().byId("table").setBusy(false);t.setProperty("/matchData",true);console.log(e.data);let o=this.getView().getModel("DataIMA22");if(typeof e.data==="object"){let t=[];t.push(e.data);o.setData(t);o.refresh()}else{o.setData(e.data);o.refresh()}return}).catch(e=>{console.error(e);if(e.response){console.error("Server responded with error: ",e.response.status,e.response.data)}else if(e.request){console.error("No response received from server: ",e.request)}else{console.error("Axios error: ",e.message)}})},onAfterRendering:function(){this.makeTitleObjAttrBold();this.disableFilterStart()},onSelectionChange:function(e){this.assignReportResume(e);this.makeTitleObjAttrBold();let t=this.getView().getModel("selectedFiltersModel");let o=t.getData();const r=e.getSource();const a=r.getName();if(r.getMetadata().getName()==="sap.m.MultiComboBox"){o[a]=r.getSelectedKeys()}else{o[a]=r.getSelectedKey()}t.setData(o);let s=o.Periodo&&o.Anno&&o.ID_STORICO&&(o.TipoContratto&&o.TipoContratto.length>0)&&(o.Entity&&o.Entity.length>0)?true:false;t.setProperty("/allSelected",s)},setEnabledDownload:function(e){const t=this.getView().byId("excelBtn");const o=this.getView().byId("pdfBtn");t.setEnabled(e);o.setEnabled(e)},disableFilterStart:function(e){const t=this.getView().byId("filterbar");const o=t._getSearchButton();if(o){o.setEnabled(false)}},makeTitleObjAttrBold:function(){const e=document.querySelectorAll(".sapFDynamicPageHeaderContent .sapUiVltCell.sapuiVltCell span");e.forEach(e=>{if(e&&e.textContent.includes(":")){const t=e.textContent.split(":");const o=document.createElement("span");o.style.fontWeight="bold";o.textContent=t[0]+": ";const r=document.createTextNode(t[1].trim());e.textContent="";e.appendChild(o);e.appendChild(r)}})},assignReportResume:function(e){const t=e.getSource();const o=t?t.getLabels()[0].getText():"";let a="";if(t.getMetadata().getName()==="sap.m.MultiComboBox"){a=t.getSelectedItems().map(e=>e.getText()).join(", ")}else if(t.getMetadata().getName()==="sap.m.Select"){const e=t.getSelectedItem();a=e?e.getText():""}else if(t.getMetadata().getName()==="sap.m.ComboBox"){const e=t.getSelectedItem();a=e?e.getText():""}const s=this.getView().byId("hLayout");const n=s.getContent();n.forEach(e=>{const t=e.getContent();t.forEach(e=>{if(e instanceof r){if(e.getTitle().toLowerCase()===o.toLowerCase()){e.setText(a);e.rerender()}}})})},onCloseLegend:function(e){var t=this.byId("legendPanel");t.setVisible(false)},_initializeFilters:function(){console.log("Filters data: ",this.getView().getModel("oFiltersModel"))},_matchData:function(){let e=this.getView().getModel("selectedFiltersModel").getData();this.getView().setModel(new t,"DataIMA22");var o=[];this.getView().getModel("DataIMA22").setData(o);this.getView().getModel("DataIMA22").refresh();console.log(this.getView().getModel("DataIMA22"))},onSearch:function(){this.getTableData()},_loadData:function(e){var o=this.byId("table");if(e){var r=this._prepareData(e.getData().Leases);var a=new t({rows:r});o.setModel(a);o.bindRows("/rows");this._createColumns(r);this._colorTotalRows();this.setTableHeight(null,o)}},_prepareData:function(e){var t=[];var o="";for(const r in e){if(Array.isArray(e[r])){e[r].forEach(e=>{let a={Category:r===o?"":r};o=r;for(let t in e){a[t]=e[t]===null?"-":e[t]}t.push(a)})}else if(r==="Summary"){let a=e[r];for(const e in a){let r={Category:e===o?"":e};let s=a[e];o=e;for(let e in s){r[e]=s[e]===null?"-":s[e]}r["_isTotal"]=true;t.push(r)}}}return t},_createColumns:function(e){var t=this.byId("table");var o=new Set;Object.keys(e[0]||{}).forEach(e=>{if(!o.has(e)){this._addColumn(e);o.add(e)}})},_addColumn:function(e){var t=this.byId("table");var o=new sap.ui.table.Column({label:new sap.m.Label({text:e}),template:new sap.m.Text({text:"{"+e+"}"}),width:"11rem"});t.addColumn(o)},setTableHeight:function(e,t){let o=window.innerHeight;let r=window.innerWidth;if(r<450){let e=Math.floor(o/100);t.setVisibleRowCount(e)}else{let e=Math.floor(o/80);t.setVisibleRowCount(e)}},_colorTotalRows:function(){var e=this.byId("table");var t=function(){var t=e.getRows();t.forEach(function(e){var t=e.getBindingContext();var o=e._mDomRefs.jQuery.row[1];var r=e._mDomRefs.jQuery.row[0];if(t&&(o||r)){var a=t.getProperty("Category");var s=t.getProperty("_isTotal");if(a==="Total"&&s===true){$(o).addClass("highlightRow");$(r).addClass("highlightRow")}else{$(o).removeClass("highlightRow");$(r).removeClass("highlightRow")}}})};e.attachEvent("rowsUpdated",t);t()},_bindToolbarText:function(){let e=this.getView().getModel("selectedFiltersModel").getData();let t=`Scenario: ${e.scenario||"-"} - Period: ${e.period||"-"} - Year: ${e.year||"-"} - Entity: ${e.entity||"-"}`},onDownloadExcelPress:function(){var e=this.byId("table");var t=e.getModel();var r=e.getBinding("rows").oList;var a=this._createColumnConfig();var s={workbook:{columns:a,context:{sheetName:"Exported Data"},styles:[{id:"header",fontSize:12,fontColor:"#ffffff",backgroundColor:"#808080",bold:true,hAlign:"Center",border:{top:{style:"thin",color:"#000000"},bottom:{style:"thin",color:"#000000"},left:{style:"thin",color:"#000000"},right:{style:"thin",color:"#000000"}}},{id:"content",fontSize:10,hAlign:"Left",border:{top:{style:"thin",color:"#000000"},bottom:{style:"thin",color:"#000000"},left:{style:"thin",color:"#000000"},right:{style:"thin",color:"#000000"}}}]},dataSource:r,fileName:"ExportedData.xlsx",worker:false};var n=new o(s);n.build().then(function(){sap.m.MessageToast.show("Excel export successful!")}).finally(function(){n.destroy()})},onDownloadPdfPress:function(){var e=this.byId("table");var t=this._createColumnConfig();var o=e.getBinding("rows").oList;var r=10;var a=[];for(var s=0;s<t.length;s+=r){a.push(t.slice(s,s+r))}for(var n in o){if(Array.isArray(o[n])){o[n].forEach(function(e){var r={Category:n,"Asset Class":e["Asset Class"]||"-"};t.forEach(function(t){r[t]=e[t]||"-"});o.push(r)})}}var i=[];a.forEach(function(e,t){var r=e.map(function(e){return{text:e,style:"tableHeader"}});var s=[r];o.forEach(function(t){var o=e.map(function(e){return{text:t[e]||"-",style:"tableCell"}});s.push(o)});i.push({table:{headerRows:1,widths:Array(e.length).fill("auto"),body:s},pageBreak:t===a.length-1?"":"after"})});var l={pageSize:"A4",pageOrientation:"landscape",content:i,styles:{tableHeader:{fontSize:12,bold:true,alignment:"center",fillColor:"#4CAF50",color:"#FFFFFF"},tableCell:{fontSize:10,alignment:"center"}}};pdfMake.createPdf(l).download("Leases_Report.pdf")},_createColumnConfig:function(){var e=this.byId("table");var t=e.getColumns();return t.map(e=>({label:e.getLabel().getText(),property:e.getLabel().getText(),type:"string"}))}})});
//# sourceMappingURL=Homepage.controller.js.map