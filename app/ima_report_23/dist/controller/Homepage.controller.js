sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/export/Spreadsheet","sap/m/ObjectAttribute","sap/ui/model/Sorter"],function(e,t,o,a,r){"use strict";return e.extend("imareport23.controller.Homepage",{filterArray:[],onInit:function(){this.getView().setModel(new t,"selectedFiltersModel");this._initializeFilters();this.osUrl=this.getOwnerComponent().getModel().sServiceUrl;this._createFiltersModel();this._getDataFilters();this.getView().setModel(new t,"DataIMA23");let e=this.getView().getModel("selectedFiltersModel");e.setProperty("/matchData",false);this.entityKeys;this.contractKeys;this.annoKey;this.periodoKey},createSorter:function(){return new r("description",false)},_createFiltersModel:function(){let e=new t({Entity:null,Contratto:null,Anno:null,Periodo:null,Id_storico:null,CompanyCode:null});this.getView().setModel(e,"oFiltersModel")},_elaboratedMonths:function(e){const t=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];return e.map(e=>parseInt(e,10)).sort((e,t)=>e-t).map(e=>({ID:e.toString().padStart(3,"0"),description:t[e-1]}))},convertModelStringToNumericValues(){var e=this.getView().getModel("DataIMA23");var t=e.getData();const o=["DEBIT","CREDIT","DEBIT_CURR","CREDIT_CURR"];t=t.map(e=>{const t=e=>e.toLocaleString("it-IT",{minimumFractionDigits:2,maximumFractionDigits:2});o.forEach(o=>{if(e[o]){const a=String(e[o]);const r=parseFloat(a);if(!isNaN(r)){e[o]=r;e[o+"_DISPLAY"]=t(r)}else{console.warn(`Valore non valido per il campo ${o}:`,a)}}});return e});e.setData(t);e.refresh()},onTableSort:function(e){const t=e.getParameter("column");const o=t.getSortProperty();const a=e.getParameter("sortOrder")==="Descending";const s=new r(o,a);this.byId("table").getBinding("rows").sort(s)},_sortEntitiesByDescription:function(e){return e.sort((e,t)=>e.description.localeCompare(t.description))},_elaborateEntities:function(e,t){const o=e.map((e,o)=>({ID:e,description:t[o]}));return this._sortEntitiesByDescription(o)},_sortStringArray:function(e){return e.sort((e,t)=>e.localeCompare(t))},_getDataFilters:function(){const e=`${this.osUrl}Filters`;axios.post(e).then(e=>{let t=this.getView().getModel("oFiltersModel");t.setData({Entity:this._elaborateEntities(e.data.BUKRS,e.data.BUTXT),Contratto:this._sortStringArray(e.data.RECNNR),Periodo:this._elaboratedMonths(e.data.PERIODDUEDATE),Anno:this._sortStringArray(e.data.YEARDUEDATE),Id_storico:this._sortStringArray(e.data.ID_STORICO)});return}).catch(e=>{console.error(e);if(e.response){console.error("Server responded with error: ",e.response.status,e.response.data)}else if(e.request){console.error("No response received from server: ",e.request)}else{console.error("Axios error: ",e.message)}})},getTableData:function(){this.getView().byId("table").setBusy(true);let e=this.getView().getModel("selectedFiltersModel").getData();let t=this.getView().getModel("selectedFiltersModel");const o={entity:Object.values(e.entity),contratto:e.contratto?Object.values(e.contratto):null,year:e.year,period:e.period,Id_storico:e.ID_STORICO};const a=`${this.osUrl}GetTabellaFiltrata23`;axios.post(a,o).then(e=>{this.getView().byId("table").setBusy(false);t.setProperty("/matchData",true);let o=this.getView().getModel("DataIMA23");if(typeof e.data==="object"){let t=[];t.push(e.data);if(t&&Array.isArray(t)){let e=t[0].value.map(this.convertExponentialValues);o.setData(e);o.refresh();this.convertModelStringToNumericValues()}}else{o.setData(e.data);o.refresh()}return}).catch(e=>{console.error(e);if(e.response){console.error("Server responded with error: ",e.response.status,e.response.data)}else if(e.request){console.error("No response received from server: ",e.request)}else{console.error("Axios error: ",e.message)}})},convertExponentialValues:function(e){for(let t in e){if(e.hasOwnProperty(t)){if(typeof e[t]==="string"&&e[t].match(/^-?\d+\.?\d*e[+\-]?\d+$/i)){let o=parseFloat(e[t]);if(!isNaN(o)){e[t]=o.toLocaleString("it-IT",{minimumFractionDigits:2,maximumFractionDigits:2})}}}}return e},onAfterRendering:function(){this.makeTitleObjAttrBold();this.disableFilterStart();console.clear()},onSelectionChange:function(e){this.assignReportResume(e);this.makeTitleObjAttrBold();let t=this.getView().getModel("selectedFiltersModel");let o=t.getData();const a=e.getSource();const r=a.getName();if(a.getMetadata().getName()==="sap.m.MultiComboBox"){o[r]=a.getSelectedKeys()}else{o[r]=a.getSelectedKey()}t.setData(o);t.refresh();this.clearFilter(e);let s=o.Periodo&&o.Anno&&o.ID_STORICO&&(o.Entity&&o.Entity.length>0)?true:false;t.setProperty("/allSelected",s);this.selectFiltering()},clearFilter:function(e){let t=this.getView().getModel("selectedFiltersModel");let o=t.getData();const a=e.getSource();const r=a.getName();let s=o[r]||[];let i;switch(r){case"ID_STORICO":i=a.getSelectedKey().length;i=true;if(i){const t=[this.getView().byId("ContrattoBox"),this.getView().byId("AnnoSelect"),this.getView().byId("PeriodoSelect"),this.getView().byId("EntityBox")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}this.assignReportResume(e,t.getLabels()[0].getText().toLowerCase(),t);this.makeTitleObjAttrBold()})}break;case"Entity":i=a.getSelectedKeys().length;i=true;if(i){const t=[this.getView().byId("AnnoSelect"),this.getView().byId("PeriodoSelect"),this.getView().byId("ContrattoBox")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}this.assignReportResume(e,t.getLabels()[0].getText().toLowerCase(),t);this.makeTitleObjAttrBold()})}break;case"Anno":i=a.getSelectedKey().length;i=true;if(i){const t=[this.getView().byId("PeriodoSelect"),this.getView().byId("ContrattoBox")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}this.assignReportResume(e,t.getLabels()[0].getText().toLowerCase(),t);this.makeTitleObjAttrBold()})}break;case"Periodo":i=a.getSelectedKey().length;i=true;if(i){const t=[this.getView().byId("ContrattoBox")];t.forEach(t=>{if(t.getMetadata().getName()==="sap.m.MultiComboBox"){t.setSelectedKeys(null)}else if(t.getMetadata().getName()==="sap.m.Select"){t.setSelectedKey(null)}else if(t.getMetadata().getName()==="sap.m.ComboBox"){t.setSelectedKey(null)}this.assignReportResume(e,t.getLabels()[0].getText().toLowerCase(),t);this.makeTitleObjAttrBold()})}break;case"Contratto":break;default:console.error("default, errore nello switch");break}},selectFiltering:function(){const e=`${this.osUrl}applyFilters23`;let t=this.getView().getModel("selectedFiltersModel").getData();const o={Id_storico:t.ID_STORICO,entity:t.entity?Object.values(t.entity):null,year:t.year,period:t.period,contratto:t.contratto?Object.values(t.contratto):null};axios.post(e,o).then(e=>{let t=this.getView().getModel("oFiltersModel");if(!o.entity||o.entity.length==0){t.getData().Contratto=this._sortStringArray(e.data.RECNNR);t.getData().Anno=this._sortStringArray(e.data.YEARDUEDATE);t.getData().Periodo=this._elaboratedMonths(e.data.PERIODDUEDATE);t.getData().Entity=this._elaborateEntities(e.data.BUKRS,e.data.BUTXT)}if(!o.year){t.getData().Anno=this._sortStringArray(e.data.YEARDUEDATE);t.getData().Periodo=this._elaboratedMonths(e.data.PERIODDUEDATE);t.getData().Contratto=this._sortStringArray(e.data.RECNNR)}if(!o.period){t.getData().Periodo=this._elaboratedMonths(e.data.PERIODDUEDATE);t.getData().Contratto=this._sortStringArray(e.data.RECNNR)}if(!o.contratto){t.getData().Contratto=this._sortStringArray(e.data.RECNNR)}t.refresh();return}).catch(e=>{console.error(e);if(e.response){console.error("Server responded with error: ",e.response.status,e.response.data)}else if(e.request){console.error("No response received from server: ",e.request)}else{console.error("Axios error: ",e.message)}})},setEnabledDownload:function(e){const t=this.getView().byId("excelBtn");const o=this.getView().byId("pdfBtn");t.setEnabled(e);o.setEnabled(e)},disableFilterStart:function(e){const t=this.getView().byId("filterbar");const o=t._getSearchButton();if(o){o.setEnabled(false)}},makeTitleObjAttrBold:function(){const e=document.querySelectorAll(".sapFDynamicPageHeaderContent .sapUiVltCell.sapuiVltCell span");e.forEach(e=>{if(e&&e.textContent.includes(":")){const t=e.textContent.split(":");const o=document.createElement("span");o.style.fontWeight="bold";o.textContent=t[0]+": ";const a=document.createTextNode(t[1].trim());e.textContent="";e.appendChild(o);e.appendChild(a)}})},assignReportResume:function(e,t,o){const r=e.getSource();const s=r?r.getLabels()[0].getText():"";let i="";let n="";if(r.getMetadata().getName()==="sap.m.MultiComboBox"){if(o!==undefined&&o.getMetadata().getName()==="sap.m.MultiComboBox"){n=o.getSelectedKeys().map(e=>e.getText()).join(", ")}else{i=r.getSelectedItems().map(e=>e.getText()).join(", ")}}else if(r.getMetadata().getName()==="sap.m.Select"){if(o!==undefined&&o.getMetadata().getName()==="sap.m.Select"){const e=o.getSelectedItem();n=e?e.getText():""}else{const e=r.getSelectedItem();i=e?e.getText():""}}else if(r.getMetadata().getName()==="sap.m.ComboBox"){if(o!==undefined&&o.getMetadata().getName()==="sap.m.ComboBox"){const e=o.getSelectedItem();n=e?e.getText():""}else{const e=r.getSelectedItem();i=e?e.getText():""}}const l=this.getView().byId("hLayout");const c=l.getContent();c.forEach(e=>{const o=e.getContent();o.forEach(e=>{if(e instanceof a){if(e.getTitle().toLowerCase()===s.toLowerCase()){e.setText(i);e.rerender()}else if(e.getTitle().toLowerCase()===t){e.setText(n);e.rerender()}}})})},onCloseLegend:function(e){var t=this.byId("legendPanel");t.setVisible(false)},_initializeFilters:function(){},_matchData:function(){let e=this.getView().getModel("selectedFiltersModel").getData();this.getView().setModel(new t,"DataIMA23");var o=[];this.getView().getModel("DataIMA23").setData(o);this.getView().getModel("DataIMA23").refresh()},onSearch:function(){this.getTableData()},_loadData:function(e){var o=this.byId("table");if(e){var a=this._prepareData(e.getData().Leases);var r=new t({rows:a});o.setModel(r);o.bindRows("/rows");this._createColumns(a);this._colorTotalRows();this.setTableHeight(null,o)}},_prepareData:function(e){var t=[];var o="";for(const a in e){if(Array.isArray(e[a])){e[a].forEach(e=>{let r={Category:a===o?"":a};o=a;for(let t in e){r[t]=e[t]===null?"-":e[t]}t.push(r)})}else if(a==="Summary"){let r=e[a];for(const e in r){let a={Category:e===o?"":e};let s=r[e];o=e;for(let e in s){a[e]=s[e]===null?"-":s[e]}a["_isTotal"]=true;t.push(a)}}}return t},_createColumns:function(e){var t=this.byId("table");var o=new Set;Object.keys(e[0]||{}).forEach(e=>{if(!o.has(e)){this._addColumn(e);o.add(e)}})},_addColumn:function(e){var t=this.byId("table");var o=new sap.ui.table.Column({label:new sap.m.Label({text:e}),template:new sap.m.Text({text:"{"+e+"}"}),width:"11rem"});t.addColumn(o)},setTableHeight:function(e,t){let o=window.innerHeight;let a=window.innerWidth;if(a<450){let e=Math.floor(o/100);t.setVisibleRowCount(e)}else{let e=Math.floor(o/80);t.setVisibleRowCount(e)}},_colorTotalRows:function(){var e=this.byId("table");var t=function(){var t=e.getRows();t.forEach(function(e){var t=e.getBindingContext();var o=e._mDomRefs.jQuery.row[1];var a=e._mDomRefs.jQuery.row[0];if(t&&(o||a)){var r=t.getProperty("Category");var s=t.getProperty("_isTotal");if(r==="Total"&&s===true){$(o).addClass("highlightRow");$(a).addClass("highlightRow")}else{$(o).removeClass("highlightRow");$(a).removeClass("highlightRow")}}})};e.attachEvent("rowsUpdated",t);t()},_bindToolbarText:function(){let e=this.getView().getModel("selectedFiltersModel").getData();let t=`Scenario: ${e.scenario||"-"} - Period: ${e.period||"-"} - Year: ${e.year||"-"} - Entity: ${e.entity||"-"}`},onDownloadExcelPress:function(){var e=this.byId("table");var t=e.getModel();var a=e.getBinding("rows").oList;var r=this._createColumnConfig();var s={workbook:{columns:r,context:{sheetName:"Exported Data"},styles:[{id:"header",fontSize:12,fontColor:"#ffffff",backgroundColor:"#808080",bold:true,hAlign:"Center",border:{top:{style:"thin",color:"#000000"},bottom:{style:"thin",color:"#000000"},left:{style:"thin",color:"#000000"},right:{style:"thin",color:"#000000"}}},{id:"content",fontSize:10,hAlign:"Left",border:{top:{style:"thin",color:"#000000"},bottom:{style:"thin",color:"#000000"},left:{style:"thin",color:"#000000"},right:{style:"thin",color:"#000000"}}}]},dataSource:a,fileName:"ExportedData.xlsx",worker:false};var i=new o(s);i.build().then(function(){sap.m.MessageToast.show("Excel export successful!")}).finally(function(){i.destroy()})},onDownloadPdfPress:function(){var e=this.byId("table");var t=e.getBinding("rows");console.log("tabella ",e);var o=t.getContexts().map(function(e){return e.getObject()});var a={pageSize:"A4",pageOrientation:"landscape",footer:{text:(new Date).toLocaleString(),style:["footerStyle"]},content:[],styles:{headerStyle:{fontSize:20,bold:true,alignment:"center",margin:[0,10,0,25]},columnStyle:{fontSize:13,bold:true,alignment:"center",margin:[0,10,0,0]},cellStyle:{fontSize:10},footerStyle:{fontSize:7,alignment:"right",margin:[0,10,10,0]}}};var r=["JOURNAL_TYPE","ACCOUNT","XMBEZ","RECNTXTOLD","IDENTOBJNR","DEBIT","CREDIT","DEBIT_CURR","CREDIT_CURR"];for(let e=0;e<r.length;e+=10){let t=r.slice(e,e+10);let s=[];let i=t.map(e=>({text:e,style:["columnStyle"]}));s.push(i);o.forEach(function(e){let o=[];t.forEach(t=>{o.push({text:e[t]||"-",style:["cellStyle"]})});s.push(o)});a.content.push({table:{widths:Array(t.length).fill("auto"),body:s},pageBreak:"after"})}if(a.content.length>0){delete a.content[a.content.length-1].pageBreak}pdfMake.createPdf(a).download()},_createColumnConfig:function(){return this.byId("table").getColumns().map(function(e){const t=e.getMultiLabels();let o={label:"",property:"",type:"string"};if(!t||!t.length){const t=e.getLabel();const a=t?t.getText():"";o.label=a;o.property=a}else{const e=t.length>1?t[1]:t[0];o.label=e.getText();o.property=e.getCustomData()[0]?.getValue()||e.getText()}return o})}})});
//# sourceMappingURL=Homepage.controller.js.map